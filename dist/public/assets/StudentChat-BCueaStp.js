import{j as e}from"./ui-D4qm5_HU.js";import{r as l}from"./vendor--0RGCJ5T.js";import{F as $,G as B,J as M,L as K,K as L,N as P,Q as V,B as x,aH as f,aO as z,O as N,V as E,C as p,g as j,ai as G,e as v,A as H,b as q,d as J,U as O,f as b,a6 as Y,aP as _,al as W,aJ as X,I as Z,z as ee,ah as g,aQ as se,w as A}from"./index-BNOyMxPp.js";import{b as te}from"./query-DwD54YTm.js";function ce(){const{user:i}=$(),{toast:d}=B(),c=te(),[u,y]=l.useState(""),[w,D]=l.useState(0),[o,C]=l.useState(0),k=l.useRef(null),S=l.useRef(null),{data:r=[],isLoading:Q}=M(["/api/chat/student"],"/api/chat/student",void 0,{enabled:!!i});K({userId:i==null?void 0:i.id,onMessage:s=>{s.type==="chat_message"?(c.setQueryData(["/api/chat/student"],t=>t?t.some(n=>n.id===s.data.id)?t:[...t,s.data]:[s.data]),s.data.sender==="counselor"&&setTimeout(()=>{m.mutate(s.data.id)},1e3)):s.type==="message_read"&&c.setQueryData(["/api/chat/student"],t=>t&&t.map(a=>a.id===s.data.messageId?{...a,read:!0}:a))}});const m=L(async s=>{await A.put(`/api/chat/messages/${s}/read`)}),h=L(async s=>await A.post("/api/chat/student",{message:s}),{onSuccess:s=>{c.setQueryData(["/api/chat/student"],t=>t?t.some(n=>n.id===s.id)?t:[...t,s]:[s]),y(""),D(Date.now()),C(15),d({title:"Message sent successfully"})},onError:s=>{d({title:"Failed to send message",description:s.message||"Please try again",variant:"destructive"})}}),T=()=>{const t=Date.now()-w;if(t<15e3&&w>0){const a=Math.ceil((15e3-t)/1e3);d({title:"Please wait",description:`You can send another message in ${a} seconds`,variant:"destructive"});return}if(!u.trim()){d({title:"Message cannot be empty",variant:"destructive"});return}h.mutate(u)},R=s=>{s.preventDefault(),d({title:"Paste not allowed",description:"Please type your message manually for security",variant:"destructive"})},U=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),T())},F=s=>{const t=s.target.value;if(/(https?:\/\/[^\s]+|www\.[^\s]+|[^\s]+\.(com|org|net|edu|gov|mil|int|co|io|ly|me|tv|info|biz)[^\s]*)/gi.test(t)){d({title:"Links not allowed",description:"Please remove any URLs from your message",variant:"destructive"});return}if(t.length>100){d({title:"Message too long",description:"Please keep messages under 100 characters",variant:"destructive"});return}y(t)};return l.useEffect(()=>{if(o>0){const s=setTimeout(()=>{C(o-1)},1e3);return()=>clearTimeout(s)}},[o]),l.useEffect(()=>{var s;(s=k.current)==null||s.scrollIntoView({behavior:"smooth"})},[r]),l.useEffect(()=>{if(!r||!i||r.length===0)return;const s=r.filter(t=>t.sender==="counselor"&&!t.read);if(s.length>0){const t=setTimeout(()=>{s.forEach(a=>{m.mutate(a.id)})},2e3);return()=>clearTimeout(t)}},[r,i,m]),l.useEffect(()=>{var s;(s=S.current)==null||s.focus()},[]),l.useCallback(async()=>{if(!r||!i)return;const s=r.filter(t=>t.sender==="counselor"&&!t.read);if(s.length>0){c.setQueryData(["/api/chat/student"],t=>t&&t.map(a=>a.sender==="counselor"&&!a.read?{...a,read:!0}:a));try{for(const t of s)await m.mutateAsync(t.id)}catch(t){console.error("Failed to mark messages as read:",t),c.setQueryData(["/api/chat/student"],a=>a&&a.map(n=>s.find(I=>I.id===n.id)?{...n,read:!1}:n))}}},[r,i,m,c]),l.useCallback(()=>{if(!r||!i)return;const s=r.filter(t=>t.sender==="counselor"&&!t.read);s.length>0&&s.forEach(t=>{m.mutate(t.id,{onSuccess:()=>{c.setQueryData(["/api/chat/student"],a=>a&&a.map(n=>n.id===t.id?{...n,read:!0}:n))}})})},[r,i,m,c]),i?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-white to-blue-50",children:[e.jsx(V,{}),e.jsxs("main",{className:"container mx-auto px-4 pt-24 pb-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(x,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(f,{href:"/dashboard/student",children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Back to Dashboard"]})}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg",children:e.jsx(N,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Chat with Counselor"}),e.jsx("p",{className:"text-gray-600",children:"Get guidance and support from your assigned counselor"})]})]})]}),e.jsxs(E,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),"Connected"]})]}),e.jsx(p,{className:"mb-6 border-amber-200 bg-amber-50",children:e.jsx(j,{className:"p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(G,{className:"w-5 h-5 text-amber-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-amber-800",children:"Chat Security Guidelines"}),e.jsxs("ul",{className:"text-sm text-amber-700 mt-2 space-y-1",children:[e.jsx("li",{children:"• Messages must be typed manually (no copying/pasting)"}),e.jsx("li",{children:"• Links and URLs are not allowed for security"}),e.jsx("li",{children:"• File attachments and images cannot be shared"}),e.jsx("li",{children:"• Please wait 15 seconds between messages"})]})]})]})})}),e.jsxs("div",{className:"grid lg:grid-cols-4 gap-6",children:[e.jsx("div",{className:"lg:col-span-3",children:e.jsxs(p,{className:"h-[600px] flex flex-col shadow-lg",children:[e.jsx(v,{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(H,{className:"w-10 h-10",children:[e.jsx(q,{src:"/api/placeholder/40/40"}),e.jsx(J,{className:"bg-indigo-600 text-white",children:e.jsx(O,{className:"w-5 h-5"})})]}),e.jsxs("div",{children:[e.jsx(b,{className:"text-lg",children:"Your Counselor"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Professional Educational Advisor"})]})]}),e.jsxs(E,{variant:"secondary",className:"bg-indigo-100 text-indigo-700",children:[e.jsx(Y,{className:"w-3 h-3 mr-1"}),"Verified"]})]})}),e.jsxs(j,{className:"flex-1 p-0 overflow-hidden flex flex-col",children:[e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:Q?e.jsx(P,{count:3}):r.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-500 space-y-3",children:[e.jsx(N,{className:"w-12 h-12 text-gray-300"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-medium",children:"No messages yet"}),e.jsx("p",{className:"text-sm",children:"Start a conversation with your counselor!"})]})]}):e.jsxs(e.Fragment,{children:[r.map(s=>e.jsx("div",{className:`flex ${s.sender==="student"?"justify-end":"justify-start"}`,"data-testid":`message-${s.sender}-${s.id}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-3 rounded-2xl shadow-sm ${s.sender==="student"?"bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-br-md":"bg-white border border-gray-200 text-gray-900 rounded-bl-md"}`,children:[e.jsx("p",{className:"text-sm leading-relaxed",children:s.message}),e.jsxs("div",{className:`flex items-center justify-between mt-2 ${s.sender==="student"?"text-indigo-100":"text-gray-500"}`,children:[e.jsx("span",{className:"text-xs",children:s.timestamp&&!isNaN(Date.parse(s.timestamp))?new Date(s.timestamp).toLocaleTimeString():new Date().toLocaleTimeString()}),s.sender==="student"&&e.jsx("div",{className:"flex items-center ml-2",children:s.read?e.jsx(_,{className:"w-3 h-3 text-indigo-200"}):e.jsx(W,{className:"w-3 h-3 text-indigo-300"})})]})]})},s.id)),e.jsx("div",{ref:k})]})}),e.jsxs("div",{className:"border-t bg-white p-4",children:[o>0&&e.jsxs("div",{className:"mb-3 p-2 bg-amber-50 border border-amber-200 rounded-lg flex items-center",children:[e.jsx(X,{className:"w-4 h-4 text-amber-600 mr-2"}),e.jsxs("span",{className:"text-sm text-amber-700",children:["Please wait ",o," seconds before sending another message"]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Z,{ref:S,value:u,onChange:F,onPaste:R,onKeyPress:U,placeholder:"Type your message... (max 100 characters)",className:"flex-1",disabled:h.isPending||o>0,maxLength:100,"data-testid":"input-message"}),e.jsx(x,{onClick:T,disabled:h.isPending||!u.trim()||o>0,className:"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700","data-testid":"button-send",children:h.isPending?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(ee,{className:"w-4 h-4"})})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[u.length,"/100 characters"]})]})]})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(p,{children:[e.jsx(v,{children:e.jsx(b,{className:"text-lg",children:"Chat Information"})}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-50 rounded-lg",children:e.jsx(N,{className:"w-4 h-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:"Total Messages"}),e.jsx("p",{className:"text-gray-600 text-sm",children:r.length})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-green-50 rounded-lg",children:e.jsx(g,{className:"w-4 h-4 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:"Counselor Status"}),e.jsx("p",{className:"text-green-600 text-sm",children:"Available"})]})]})]})]}),e.jsxs(p,{children:[e.jsx(v,{children:e.jsx(b,{className:"text-lg",children:"Quick Actions"})}),e.jsxs(j,{className:"space-y-2",children:[e.jsx(x,{variant:"outline",className:"w-full justify-start",asChild:!0,children:e.jsxs(f,{href:"/applications",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"View Applications"]})}),e.jsx(x,{variant:"outline",className:"w-full justify-start",asChild:!0,children:e.jsxs(f,{href:"/documents",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"Upload Documents"]})}),e.jsx(x,{variant:"outline",className:"w-full justify-start",asChild:!0,children:e.jsxs(f,{href:"/universities",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"Browse Universities"]})})]})]})]})]})]}),e.jsx(se,{})]}):e.jsx(P,{type:"card",count:3})}export{ce as default};
